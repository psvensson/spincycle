// Generated by CoffeeScript 1.8.0
(function() {
  var ClientEndpoints, IO, WsMethod, uuid;

  IO = require("socket.io");

  uuid = require('node-uuid');

  ClientEndpoints = require('./ClientEndpoints');

  WsMethod = (function() {
    WsMethod.wsroutes = [];

    function WsMethod(server, messageRouter) {
      var io;
      io = IO(server);
      io.on("connection", function(socket) {
        var ip, port;
        ip = socket.request.connection.remoteAddress;
        port = socket.request.connection.remotePort;
        console.log('new ws connection from ' + ip + ':' + port);
        ClientEndpoints.registerEndpoint(ip + ':' + port, function(msg) {
          return socket.emit('message', msg);
        });
        socket.on("message", function(datastring) {
          var data, _base, _name;
          data = JSON.parse(datastring);
          data.client = ip + ':' + port;
          data.messageId = data.messageId || uuid.v4();
          data.replyFunc = function(reply) {
            reply.messageId = data.messageId;
            reply.target = data.target;
            return socket.emit('message', reply);
          };
          return typeof (_base = WsMethod.wsroutes)[_name = data.target] === "function" ? _base[_name](data) : void 0;
        });
        return socket.on("disconnect", function() {
          var adr;
          adr = ip + ':' + port;
          console.log('client at ' + adr + ' disconnected');
          return ClientEndpoints.removeEndpoint(adr);
        });
      });
      messageRouter.addMethod('ws', function(targetName, targetFunc) {
        return WsMethod.wsroutes[targetName] = targetFunc;
      });
    }

    return WsMethod;

  })();

  module.exports = WsMethod;

}).call(this);

//# sourceMappingURL=WsMethod.js.map

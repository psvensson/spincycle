<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<dom-module id="spin-elementlist">

    <template>
        <style>
        </style>
        <div>
            <content></content>
        </div>
    </template>

    <script>
			Polymer( {
				is:         'spin-elementlist',
				properties: {
					client:     {type: 'Object', observer: 'onStuff'},
					user:       {type: 'Object', observer: 'onStuff'},
					spintype:   {type: String, observer: 'onStuff'},
					list:       {type: Array, notify: true},
					filteruser: {type: Boolean, value: false},
					filterids:  {type: Array},
					captions:   {type: Object, observer: 'onStuff'},
					query:      {type: Object, observer: 'onStuff'}
				},

				ready: function ()
				       {
					       this.getModelList()
				       },

				attached: function ()
				          {

				          },

				onStuff: function ()
				         {
					         if (this.spintype && this.client && this.captions && this.user)
					         {
						         this.getModelList()
					         }
				         },

				getModelList: function ()
				              {
					              console.log( '---spin-elementlist get all elements. this.filteruser = ' + this.filteruser + ' this.user = ' + this.user + ' query = ' + this.query )
					              console.dir( this.query )
					              var q = {sort: 'name'}
					              if (this.filteruser == true && this.user)
					              {
						              q = {sort: 'name', property: 'createdBy', value: this.user.id}
					              }
					              if (this.query)
					              {
						              q = this.query
					              }
					              console.log( 'query is' )
					              console.dir( q )
					              this.client.emitMessage( {
						              target: '_list' + this.spintype + 's',
						              query:  q
					              } ).then( function ( newlist )
					              {
						              console.log( 'spin-elementlist for ' + this.spintype + ' fetchpage got ' + newlist.length + ' items back' )
						              //console.dir( newlist )
						              newlist.sort( function ( a, b )
						              {
							              return a.modifiedAt == b.modifiedAt ? 0 : a.modifiedAt < b.modifiedAt ? 1 : -1
						              } )
						              if (!this.list)
						              {
							              this.list = this.filterIds( newlist )
							              this.list.forEach( function ( el, idx )
							              {
								              (function ( i )
								              {
									              this.client.registerObjectSubscriber( {
										              id: el.id, type: el.type, cb: function ( co )
										              {
											              //console.log('spin-elementlist getting object update')
											              //console.dir(co)
											              this.splice( 'list', i, co )
										              }.bind( this )
									              } )
								              }.bind( this ))( idx )
							              }.bind( this ) )
						              }
						              else
						              {
							              var _newlist = this.filterIds( newlist )
							              this.splice( 'list', 0, this.list.length )
							              _newlist.forEach( function ( el )
							              {
								              this.push( 'list', el )
							              }.bind( this ) )
							              this.drawQuickSelectBar()
						              }
						              this.registerPopulationListener()
					              }.bind( this ) )
				              },

				filterIds: function ( newlist )
				           {
					           var rv = newlist
					           if (this.filterids && this.filterids.length > 0)
					           {
						           var away = []
						           this.filterids.forEach( function ( fid )
						           {
							           var idx = -1
							           rv.forEach( function ( el, i )
							           {
								           if (el.id == fid)
								           {
									           idx = i
								           }
							           } )
							           if (idx > -1)
							           {
								           rv.splice( idx, 1 )
							           }
						           } )
					           }
					           return rv
				           },

				registerPopulationListener: function ()
				                            {
					                            if (this.listenerid)
					                            {
						                            this.client.deRegisterPopulationChangesSubscriber( {
							                            type:       this.spintype,
							                            listenerid: this.listenerid
						                            } )
					                            }
					                            this.client.registerPopulationChangeSubscriber( {
						                            type: this.spintype, cb: function ( popchange )
						                            {
							                            console.log( 'spin-elementlist --------------------population change callback for ' + this.spintype )
							                            console.dir( popchange )
							                            if (popchange.removed)
							                            {
								                            var idx = -1
								                            this.list.forEach( function ( el, i )
								                            {
									                            if (el.id === popchange.removed.id)
									                            {
										                            idx = i
									                            }
								                            } )
								                            if (idx > -1)
								                            {
									                            this.splice( 'list', idx, 1 )
								                            }
							                            }
							                            else
							                            {
								                            this.unshift( 'list', popchange.added )
							                            }

							                            console.log( 'elementlist is now..' )
							                            console.dir( this.list )
						                            }.bind( this )
					                            } ).then( function ( listenid )
					                            {
						                            this.listenerid = listenid
					                            }.bind( this ) )
				                            },

				onSelect: function ( e )
				          {

				          }
			} );

    </script>

</dom-module>

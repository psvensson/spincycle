<script src="../bower_components/q/q.js"></script>
<script src="../bower_components/uuid4/lib/browser/index.js"></script>
<script src="../bower_components/lrucache/index.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="spinclient.js"></script>

<link rel="import" href="../bower_components/polymer-cookie/polymer-cookie.html">

<dom-module id="spin-client">
    <template>
        <style>

        </style>
        <polymer-cookie id="sidcookie" name="sid" ></polymer-cookie>
    </template>

    <script>
        Polymer({
            is: 'spin-client',
            properties:
                {
                    client:{type:'Object', notify: true},
                    user: {type:'Object', notify: true, observer: 'onUserChanged'},
                    failure:{type:'String', notify:true}
                },

            listeners:
            {
                'user-changed': 'onUserChanged'
            },


            ready: function()
                   {
                       (function(){
                           var cookies;

                           function readCookie(name,c,C,i){
                               if(cookies){ return cookies[name]; }

                               c = document.cookie.split('; ');
                               cookies = {};

                               for(i=c.length-1; i>=0; i--){
                                   C = c[i].split('=');
                                   if(C[1])
                                   {
                                       cookies[C[0]] = C[1];
                                   }
                               }
                               console.log('---- cookies----')
                               console.dir(cookies)

                               return cookies[name];
                           }

                           window.readCookie = readCookie; // or expose it however you want
                       })();
                   },

            onUserChanged: function ( e )
                           {
                               //console.log( '********************* spin-client onUserChanged called.' )
                               if(e && e.id)
                               {
                                   this.set('user', e)
                                   //console.dir(this.user)
                                   this.client.emitMessage( {
                                       target: '_updateGEUser',
                                       obj:    this.user
                                   } ).then( function ( ures )
                                   {
                                       console.log( 'user update result: ' + ures )
                                   }.bind( this ) )
                               }
                           },

            attached: function()
                      {
                          window.spinclient = new window.SpinClient('')
                          console.log('spin-client attached.')
                          this.set('client', window.spinclient)
                          this.client.setUser = this.onUserChanged.bind( this )
                          this.client.onFailure = this.onFailure.bind(this)
                          cookie = this.$.sidcookie
                          var sid = cookie.readCookie()
                          console.log('all cookies are: '+document.cookie)
                          console.log('existing sid cookie = '+sid)
                          var wsid = window.readCookie('sid')
                          console.log('window.readcookie says... '+wsid)
                          this.client.setSessionId(sid || wsid)
                          this.addEventListener('user-changed', this.onUserChanged.bind(this))
                      },

            onFailure:function(ftext)
                      {
                          this.set('failure', ftext)
                          this.client.failureListeners.forEach(function(cb)
                          {
                              cb(ftext)
                          })
                      }

        });

    </script>

</dom-module>

// Generated by CoffeeScript 1.8.0
(function() {
  var ClientEndpoints, DB, ObjectManager, defer, e, error, objStore, util,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  util = require('util');

  defer = require('node-promise').defer;

  e = require('./EventManager');

  DB = require('./DB');

  ClientEndpoints = require('./ClientEndpoints');

  objStore = require('./OStore');

  error = require('./Error').error;

  ObjectManager = (function() {
    function ObjectManager(messageRouter) {
      this.messageRouter = messageRouter;
      this.onRegisterForUpdatesOn = __bind(this.onRegisterForUpdatesOn, this);
      this.onUpdateObject = __bind(this.onUpdateObject, this);
      this.setup = __bind(this.setup, this);
      this.games = [];
    }

    ObjectManager.prototype.setup = function() {
      this.messageRouter.addTarget('registerForUpdatesOn', 'obj', this.onRegisterForUpdatesOn);
      return this.messageRouter.addTarget('updateObject', 'obj', this.onUpdateObject);
    };

    ObjectManager.prototype.onUpdateObject = function(msg) {
      console.log('onUpdateObject called for ' + msg.obj.type + ' - ' + msg.obj.id);
      return objStore.getObject(msg.obj.id, msg.obj.type).then((function(_this) {
        return function(record) {
          if (record) {
            if (_this.messageRouter.authMgr.canUserWriteToThisObject(record, msg.user)) {
              objStore.updateObj(msg.obj);
              DB.set(record.type, objStore.getObject(msg.obj.id));
              return msg.replyFunc({
                status: e.general.SUCCESS,
                info: e.gamemanager.UPDATE_OBJECT_SUCCESS,
                payload: msg.obj.id
              });
            } else {
              return msg.replyFunc({
                status: e.general.NOT_ALLOWED,
                info: e.gamemanager.UPDATE_OBJECT_FAIL,
                payload: msg.obj.id
              });
            }
          } else {
            return msg.replyFunc({
              status: e.general.NOT_ALLOWED,
              info: e.gamemanager.NO_SUCH_OBJECT,
              payload: msg.obj.id
            });
          }
        };
      })(this));
    };

    ObjectManager.prototype.onRegisterForUpdatesOn = function(msg) {
      console.log('onRegisterForUpdatesOn called for ' + msg.obj.type + ' ' + msg.obj.id);
      return objStore.getObject(msg.obj.id, msg.obj.type).then((function(_this) {
        return function(record) {
          var listenerId;
          if (record) {
            if (_this.messageRouter.authMgr.canUserReadFromThisObject(record, msg.user)) {
              listenerId = objStore.addListenerFor(msg.obj.id, msg.obj.type, function(uobj) {
                console.log('--------------------- sending update of object ' + msg.obj.id + ' type ' + msg.obj.type + ' to client');
                console.dir(uobj);
                return ClientEndpoints.sendToEndpoint(msg.client, {
                  status: e.general.SUCCESS,
                  info: e.gamemanager.OBJECT_UPDATE,
                  payload: uobj.toClient()
                });
              });
              return msg.replyFunc({
                status: e.general.SUCCESS,
                info: e.gamemanager.REGISTER_UPDATES,
                payload: listenerId
              });
            } else {
              return msg.replyFunc({
                status: e.general.NOT_ALLOWED,
                info: e.gamemanager.UPDATE_REGISTER_FAIL,
                payload: msg.obj.id
              });
            }
          } else {
            return msg.replyFunc({
              status: e.general.NOT_ALLOWED,
              info: e.gamemanager.NO_SUCH_OBJECT,
              payload: msg.obj.id
            });
          }
        };
      })(this), error);
    };

    return ObjectManager;

  })();

  module.exports = ObjectManager;

}).call(this);

//# sourceMappingURL=ObjectManager.js.map
